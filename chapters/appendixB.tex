\section{DynaPyt Analysis}
\lstset{numbers=left, numberstyle=\tiny, stepnumber=1, numbersep=5pt, columns=flexible, breaklines=true, numberblanklines=false}
\lstset{basicstyle=\ttfamily}
\lstset{frame=tb}

\begin{lstlisting}[caption=Call Graph Analysis in DynaPyt,label=code:CallGraphAnalysis,language=Python]
from typing import Callable, Tuple, Dict
import logging
import libcst as cst
import libcst.matchers as m
from .BaseAnalysis import BaseAnalysis
from ..utils.nodeLocator import get_parent_by_type
import json
from inspect import getmodule

class CallGraph(BaseAnalysis):
    def __init__(self):
        super(CallGraph, self).__init__()
        logging.basicConfig(filename="dynapyt.json", format='%(message)s', level=logging.INFO)
        self.graph = {}

    '''
    DynaPyt hook for pre function call
    '''
    def pre_call(self, dyn_ast: str, iid: int, function: Callable, pos_args: Tuple, kw_args: Dict):
        ast, iids = self._get_ast(dyn_ast)
        module = getmodule(function)
        module = str(module).split(' ')[1] if module is not None else "''"
        # calling function 
        caller = get_parent_by_type(ast, iids.iid_to_location[iid], m.FunctionDef())
        # called function
        if hasattr(function, "__qualname__"):
            callee = module[1:-1] + '.' + function.__qualname__ if module != "''" else function.__qualname__
        else:
            temp = str(function)
            callee = temp
        
        #file name
        key = dyn_ast.replace('.py.orig', '').replace('/','.')
        
        if caller is None:
            f = key
        else:
            # if caller is a part of class, find the class name
            caller_parent = get_parent_by_type(ast, iids.iid_to_location[iid], m.ClassDef())
            if caller_parent is None:
                f = key + '.' + caller.name.value
            else:
                f = key + '.' + caller_parent.name.value + '.' + caller.name.value

        # if caller already added
        if f in self.graph.keys():
            temp = self.graph[f]
            # filter dupilcate callees
            if callee not in temp:
                temp.append(callee)
                self.graph[f] = temp
        else:
            self.graph[f] = [callee]
    
    def end_execution(self):
        try:
            logging.info(json.dumps(self.graph))
        except Exception:
            logging.info("{")
            for idx, key in enumerate(self.graph):                
                if not idx == (len(self.graph.keys()) - 1):
                    logging.info("{} : {}, ".format(key, self.graph[key]))
                else:
                    logging.info("{} : {}".format(key, self.graph[key]))
            logging.info("}")
                
\end{lstlisting}

\section{DyPyBench}
\lstset{numbers=left, numberstyle=\tiny, stepnumber=1, numbersep=5pt, columns=flexible, breaklines=true, numberblanklines=false}
\lstset{basicstyle=\ttfamily}
\lstset{frame=tb}
\begin{lstlisting}[caption=Access Interface of DyPyBench,label=code:dypybench.py,language=Python]
import argparse
import subprocess
import csv
import os

parser = argparse.ArgumentParser()
parser.add_argument(
    "--list", "-l", action="store_true", help="List all the projects DyPyBench supports"
)

parser.add_argument(
    "--timeout", type=int, help="Specify timeout to be used in seconds for execution of subprocesses", default=(60*10)
)

parser.add_argument(
    "--test", "-t", type=int, nargs='+', help="Specify the project number to run the test suite"
)

parser.add_argument(
    "--test_original", "-to", action="store_true", help="Run tests on original code"
)

parser.add_argument(
    "--save", "-s", type=str, help="Specify file name to save the stdout and stderr combined"
)

parser.add_argument(
    "--update_dynapyt_source", action="store_true", help="get dynapyt source code"
)

parser.add_argument(
    "--update_lex_source", action="store_true", help="get LExecutor source code"
)

parser.add_argument(
    "--dynapyt_instrument", "-di", type=int, nargs='+', help="Specify the project no. to run DynaPyt instrumentation"
)

parser.add_argument(
    "--dynapyt_file", "-df", type=str, help="Specify the path to file containing the includes.txt file to run the instrumentation"
)

parser.add_argument(
    "--dynapyt_analysis", "-da", help="Specify DynaPyt analysis to run"
)

parser.add_argument(
    "--dynapyt_run", "-dr", type=int, nargs='+', help="Specify the project no. to run DynaPyt Analysis"
)

parser.add_argument(
    "--lex_instrument", "-li", type=int, nargs='+', help="Specify the project no. to run LExecutor instrumentation"
)

parser.add_argument(
    "--lex_file", "-lf", type=str, help="Specify the path to file containing the includes.txt file to run the instrumentation"
)

parser.add_argument(
    "--lex_test", "-lt", type=int, nargs='+', help="Specify the project no. to run test suite for LExecutor"
)

parser.add_argument(
    "--pycg", "-scg", type=int, nargs='+', help="Specify the project no. to run PyCG for static call graph generation"
)

def printAllProjects():
    print("{:<8} {:<20} {:<50}".format("Number", "Project Name", "Repository URL"))
    print("{:<8} {:<20} {:<50}".format("-------", "--------------", "---------------------------------"))
    for value in data:
        no, name, url = value
        print("{:<8} {:<20} {:<50}".format(no, name, url))

def setupProjects():
    global data
    global original_data
    data = []
    original_data = []
    with open("/DyPyBench/text/github-url.txt", "r") as csv_file:
        csvReader = csv.reader(csv_file, delimiter=" ")
        for index, row in enumerate(csvReader):
            temp=[]
            temp.append(index + 1)
            temp.append(row[0].split("/")[-1].split(".git")[0])
            temp.append(row[0])
            data.append(temp)
            original_data.append(row)

def get_project_name(proj_no):
    for value in data:
        no, name, url = value
        if(proj_no == no):
            return name

def get_project_no(proj_name):
    for value in data:
        no, name, url = value
        if(proj_name == name):
            return str(no)

if __name__ == '__main__':
    args = parser.parse_args()

    setupProjects()

    if args.list:
        printAllProjects()

    if args.update_dynapyt_source:
        # print("Downloading the dynapyt source from git")
        if args.save:
            output = subprocess.run(["/DyPyBench/scripts/setup-DynaPyt-src.sh"
            ], shell=True, stdout=open(args.save,'a+',1), stderr=subprocess.STDOUT)
        else:
            output = subprocess.run(["/DyPyBench/scripts/setup-DynaPyt-src.sh"
            ], shell=True, capture_output=True)
            #if output needs to be printed on the console then comment above and uncomment below
            """output = subprocess.run(["/DyPyBench/scripts/setup-DynaPyt-src.sh"
            ], shell=True, stderr=subprocess.STDOUT)"""

    if args.update_lex_source:
        # print("Downloading the LExecutor source from git")
        if args.save:
            output = subprocess.run(["/DyPyBench/scripts/setup-LExecutor-src.sh"
            ], shell=True, stdout=open(args.save,'a+',1), stderr=subprocess.STDOUT)
        else:
            output = subprocess.run(["/DyPyBench/scripts/setup-LExecutor-src.sh"
            ], shell=True, capture_output=True)
            #if output needs to be printed on the console then comment above and uncomment below
            """output = subprocess.run(["/DyPyBench/scripts/setup-LExecutor-src.sh"
            ], shell=True, stderr=subprocess.STDOUT)"""

    if args.test:
        projects = args.test
        if 0 in projects:
            projects = [x for x in range(1,51)]
        for project in projects:
            if(project < 0 or project > 50):
                print("Project number should be between 1 and 50")
            else:
                proj_name = str(data[project - 1][1])
                proj_no = str(data[project - 1][0])
                proj_flags = str(original_data[project - 1][1])
                copy_folder = args.test_original
                if(proj_flags == "rt"):
                    proj_test_folder = str(original_data[project - 1][3])
                elif(proj_flags == "t"):
                    proj_test_folder = str(original_data[project - 1][2])
                elif(proj_flags == "r"):
                    proj_test_folder = ""

                if args.save:
                    output = subprocess.run(["/DyPyBench/scripts/run-test.sh %s %s %s %s %s" %(proj_name, proj_no, proj_test_folder, copy_folder, args.timeout)
                    ], shell=True, stdout=open(args.save,'a+',1), stderr=subprocess.STDOUT, timeout=args.timeout)
                else:
                    output = subprocess.run(["/DyPyBench/scripts/run-test.sh %s %s %s %s %s" %(proj_name, proj_no, proj_test_folder, copy_folder, args.timeout)
                    ], shell=True, capture_output=True, timeout=args.timeout)
                    #if output needs to be printed on the console then comment above and uncomment below
                    """output = subprocess.run(["/DyPyBench/scripts/run-test.sh %s %s %s %s %s" %(proj_name, proj_no, proj_test_folder, copy_folder, args.timeout)
                    ], shell=True, stderr=subprocess.STDOUT, timeout=args.timeout)"""

    if args.dynapyt_instrument:
        projects = args.dynapyt_instrument
        if 0 in projects:
            projects = [x for x in range(1,51)]
        for project in projects:
            if(project < 0 or project > 50):
                print("Project number should be between 1 and 50")
            else:
                proj_name = str(data[project - 1][1])
                proj_no = str(data[project - 1][0])
                instr_file = args.dynapyt_file
                analysis = args.dynapyt_analysis

                with open(instr_file, 'r') as inst_file:
                    csvReader = csv.reader(inst_file, delimiter=" ")
                    instr_details = {}
                    for row in csvReader:
                        project_name, flag, path = row
                        project_no = get_project_no(project_name)
                        if project_no in instr_details.keys():
                            temp = instr_details[project_no]
                            temp.append((project_no, flag, path))
                            instr_details[project_no] = temp
                        else:
                            instr_details[project_no] = [(project_no, flag, path)]

                if args.save:
                    output = subprocess.run(["/DyPyBench/scripts/clear-project.sh %s %s" %(proj_name, proj_no)
                            ], shell=True, stdout=open(args.save,'a+',1), stderr=subprocess.STDOUT, timeout=args.timeout)
                else:
                    output = subprocess.run(["/DyPyBench/scripts/clear-project.sh %s %s" %(proj_name, proj_no)
                    ], shell=True, capture_output=True, timeout=args.timeout)
                    #if output needs to be printed on the console then comment above and uncomment below
                    """output = subprocess.run(["/DyPyBench/scripts/clear-project.sh %s %s" %(proj_name, proj_no)
                    ], shell=True, stderr=subprocess.STDOUT, timeout=args.timeout)"""

                for line in instr_details[proj_no]:
                    project_no, flag, path = line
                    if args.save:
                        output = subprocess.run(["/DyPyBench/scripts/run-dynapyt-instrumentation.sh %s %s %s %s %s %s" %(proj_name, proj_no, path, analysis, flag, args.timeout)
                        ], shell=True, stdout=open(args.save,'a+',1), stderr=subprocess.STDOUT, timeout=args.timeout)
                    else:
                        output = subprocess.run(["/DyPyBench/scripts/run-dynapyt-instrumentation.sh %s %s %s %s %s %s" %(proj_name, proj_no, path, analysis, flag, args.timeout)
                        ], shell=True, capture_output=True, timeout=args.timeout)
                        #if output needs to be printed on the console then comment above and uncomment below
                        """output = subprocess.run(["/DyPyBench/scripts/run-dynapyt-instrumentation.sh %s %s %s %s %s %s" %(proj_name, proj_no, path, analysis, flag, args.timeout)
                        ], shell=True, stderr=subprocess.STDOUT, timeout=args.timeout)"""

    if args.dynapyt_run:
        projects = args.dynapyt_run
        if 0 in projects:
            projects = [x for x in range(1,51)]
        for project in projects:
            if(project < 0 or project > 50):
                print("Project number should be between 1 and 50")
            else:
                proj_name = str(data[project - 1][1])
                proj_no = str(data[project - 1][0])
                analysis = args.dynapyt_analysis
                proj_flags = str(original_data[project - 1][1])
                if(proj_flags == "rt"):
                    proj_test_folder = str(original_data[project - 1][3])
                elif(proj_flags == "t"):
                    proj_test_folder = str(original_data[project - 1][2])
                elif(proj_flags == "r"):
                    proj_test_folder = ""

                if args.save:
                    # os.system("/DyPyBench/scripts/run-dynapyt-analysis.sh %s %s %s %s >> %s 2>&1" %(proj_name, proj_no, analysis, proj_test_folder, args.save))
                    output = subprocess.run(["/DyPyBench/scripts/run-dynapyt-analysis.sh %s %s %s %s %s" %(proj_name, proj_no, analysis, proj_test_folder, args.timeout)
                    ], shell=True, stdout=open(args.save,'a+',1), stderr=subprocess.STDOUT, timeout=args.timeout)
                else:
                    # os.system("/DyPyBench/scripts/run-dynapyt-analysis.sh %s %s %s %s" %(proj_name, proj_no, analysis, proj_test_folder))
                    output = subprocess.run(["/DyPyBench/scripts/run-dynapyt-analysis.sh %s %s %s %s %s" %(proj_name, proj_no, analysis, proj_test_folder, args.timeout)
                    ], shell=True, capture_output=True, timeout=args.timeout)
                    #if output needs to be printed on the console then comment above and uncomment below
                    """output = subprocess.run(["/DyPyBench/scripts/run-dynapyt-analysis.sh %s %s %s %s %s" %(proj_name, proj_no, analysis, proj_test_folder, args.timeout)
                    ], shell=True, stderr=subprocess.STDOUT, timeout=args.timeout)"""

    if args.lex_instrument:
        projects = args.lex_instrument
        if 0 in projects:
            projects = [x for x in range(1,51)]
        for project in projects:
            if(project < 0 or project > 50):
                print("Project number should be between 1 and 50")
            else:
                proj_name = str(data[project - 1][1])
                proj_no = str(data[project - 1][0])
                instr_file = args.lex_file

                with open(instr_file, 'r') as inst_file:
                    csvReader = csv.reader(inst_file, delimiter=" ")
                    instr_details = {}
                    for row in csvReader:
                        project_name, path = row
                        project_no = get_project_no(project_name)
                        if project_no in instr_details.keys():
                            temp = instr_details[project_no]
                            temp.append((project_no, path))
                            instr_details[project_no] = temp
                        else:
                            instr_details[project_no] = [(project_no, path)]

                if args.save:
                    output = subprocess.run(["/DyPyBench/scripts/clear-project.sh %s %s" %(proj_name, proj_no)
                            ], shell=True, stdout=open(args.save,'a+',1), stderr=subprocess.STDOUT, timeout=args.timeout)
                else:
                    output = subprocess.run(["/DyPyBench/scripts/clear-project.sh %s %s" %(proj_name, proj_no)
                    ], shell=True, capture_output=True, timeout=args.timeout)
                    #if output needs to be printed on the console then comment above and uncomment below
                    """output = subprocess.run(["/DyPyBench/scripts/clear-project.sh %s %s" %(proj_name, proj_no)
                    ], shell=True, stderr=subprocess.STDOUT, timeout=args.timeout)"""

                files = []
                for line in instr_details[proj_no]:
                    project_no, file_path = line
                    files.append(file_path)

                path = ' '.join([str(path) for path in files])

                if args.save:
                    output = subprocess.run(["/DyPyBench/scripts/run-lex-instrumentation.sh %s %s %s %s" %(proj_name, proj_no, args.timeout, path)
                    ], shell=True, stdout=open(args.save,'a+',1), stderr=subprocess.STDOUT, timeout=args.timeout)
                else:
                    output = subprocess.run(["/DyPyBench/scripts/run-lex-instrumentation.sh %s %s %s %s" %(proj_name, proj_no, args.timeout, path)
                    ], shell=True, capture_output=True, timeout=args.timeout)
                    #if output needs to be printed on the console then comment above and uncomment below
                    """output = subprocess.run(["/DyPyBench/scripts/run-lex-instrumentation.sh %s %s %s %s" %(proj_name, proj_no, args.timeout, path)
                    ], shell=True, stderr=subprocess.STDOUT, timeout=args.timeout)"""

    if args.lex_test:
        projects = args.lex_test
        if 0 in projects:
            projects = [x for x in range(1,51)]
        for project in projects:
            if(project < 0 or project > 50):
                print("Project number should be between 1 and 50")
            else:
                proj_name = str(data[project - 1][1])
                proj_no = str(data[project - 1][0])
                proj_flags = str(original_data[project - 1][1])
                if(proj_flags == "rt"):
                    proj_test_folder = str(original_data[project - 1][3])
                elif(proj_flags == "t"):
                    proj_test_folder = str(original_data[project - 1][2])
                elif(proj_flags == "r"):
                    proj_test_folder = ""

                if args.save:
                    # os.system("/DyPyBench/scripts/run-test-lexecutor.sh %s %s %s %s >> %s 2>&1" %(proj_name, proj_no, proj_test_folder, args.save))
                    output = subprocess.run(["/DyPyBench/scripts/run-lex-test.sh %s %s %s %s" %(proj_name, proj_no, proj_test_folder, args.timeout)
                    ], shell=True, stdout=open(args.save,'a+',1), stderr=subprocess.STDOUT, timeout=args.timeout)
                else:
                    # os.system("/DyPyBench/scripts/run-test-lexecutor.sh %s %s %s %s" %(proj_name, proj_no, proj_test_folder))
                    output = subprocess.run(["/DyPyBench/scripts/run-lex-test.sh %s %s %s %s" %(proj_name, proj_no, proj_test_folder, args.timeout)
                    ], shell=True, capture_output=True, timeout=args.timeout)
                    #if output needs to be printed on the console then comment above and uncomment below
                    """output = subprocess.run(["/DyPyBench/scripts/run-lex-test.sh %s %s %s %s" %(proj_name, proj_no, proj_test_folder, args.timeout)
                    ], shell=True, stderr=subprocess.STDOUT, timeout=args.timeout)"""

    if args.pycg:
        projects = args.pycg
        if 0 in projects:
            projects = [x for x in range(1,51)]
        for project in projects:
            if(project < 0 or project > 50):
                print("Project number should be between 1 and 50")
            else:
                proj_name = str(data[project - 1][1])
                proj_no = str(data[project - 1][0])
                proj_flags = str(original_data[project - 1][1])
                if(proj_flags == "rt"):
                    proj_test_folder = str(original_data[project - 1][3])
                elif(proj_flags == "t"):
                    proj_test_folder = str(original_data[project - 1][2])
                elif(proj_flags == "r"):
                    proj_test_folder = ""

                flag = "folder"
                if proj_test_folder.__contains__(".py"):
                    flag = "file"

                if args.save:
                    output = subprocess.run(["/DyPyBench/scripts/run-pycg.sh %s %s %s %s %s" %(proj_name, proj_no, proj_test_folder, flag, args.timeout)
                    ], shell=True, stdout=open(args.save,'a+',1), stderr=subprocess.STDOUT, timeout=args.timeout)
                else:
                    output = subprocess.run(["/DyPyBench/scripts/run-pycg.sh %s %s %s %s %s" %(proj_name, proj_no, proj_test_folder, flag, args.timeout)
                    ], shell=True, capture_output=True, timeout=args.timeout)
                    #if output needs to be printed on the console then comment above and uncomment below
                    """output = subprocess.run(["/DyPyBench/scripts/run-pycg.sh %s %s %s %s %s" %(proj_name, proj_no, proj_test_folder, flag, args.timeout)
                    ], shell=True, stderr=subprocess.STDOUT, timeout=args.timeout)"""

\end{lstlisting}

\lstset{numbers=left, numberstyle=\tiny, stepnumber=1, numbersep=5pt, columns=flexible, breaklines=true, numberblanklines=false}
\lstset{basicstyle=\ttfamily}
\lstset{frame=tb}

\begin{lstlisting}[caption=Bash Script for Project Selection,label=code:project_selection_automation.sh,language=Bash]
#root directory
ROOT_DIR=$(pwd)

#read URL_FILE
URL_FILE=$ROOT_DIR/text/github-url.txt

# Create project folder to keep all the projects together inside one parent folder
PROJ_DIR=$ROOT_DIR/Project
#if folder already present, then delete the folder
if [[ ! -d "$ROOT_DIR/$PROJ_DIR" ]]
then
    mkdir -p "$ROOT_DIR/$PROJ_DIR" 
fi
cd "$ROOT_DIR/$PROJ_DIR"

#run a while loop for all projects
idx=1
while read line
do
    parts=($line)
    URL=${parts[0]}
    FLAGS=${parts[1]}
    if [[ $FLAGS == "rt" ]]
    then
        REQ_FILE=${parts[2]}
        TEST_SUITE=${parts[3]}
    elif [[ $FLAGS == "t" ]]
    then
        TEST_SUITE=${parts[2]}
    fi
    
    #change to working directory
    cd $PROJ_DIR
    
    #create directory for project
    mkdir -p "project$idx"
    
    #clone the repo to project directory
    git clone "$URL" "project$idx"
    cd "project$idx"
    
    #create virtual env name .vm
    virtualenv .vm
    
    #activate virtual env
    if [[ -d ".vm/local" ]]
    then
        source .vm/local/bin/activate
    elif [[ -d ".vm/bin" ]]
    then
        source .vm/bin/activate
    else
        echo "Unable to create virtual env"
        exit
    fi

    #install using pip install . 
    echo "Running pip install ."
    pip install .

    if [[ $FLAGS == "rt" ]]
    then
        if [[ $URL == "https://github.com/spotify/dh-virtualenv.git" ]]
        then
            sed -i.bak '0,/invoke==0.13.0/s//invoke/' dev-requirements.txt  #fix for dependency conflict issue
        fi
        echo "Running pip install requirements"
        pip install -r $REQ_FILE
    fi

    #some projects need extra requirements for running test suites
    if [[ $URL == "https://github.com/lorien/grab.git" ]]
    then
        pip install cssselect pyquery pymongo fastrq #required for running tests
    elif [[ $URL == "https://github.com/psf/black.git" ]]
    then
        pip install aiohttp #required for running tests
    elif [[ $URL == "https://github.com/errbotio/errbot.git" ]]
    then
        pip install mock #required for running tests
    elif [[ $URL == "https://github.com/PyFilesystem/pyfilesystem2.git" ]]
    then
        pip install parameterized pyftpdlib psutil #required for running tests
    elif [[ $URL == "https://github.com/wtforms/wtforms.git" ]]
    then
        pip install babel email_validator #required for running tests
    elif [[ $URL == "https://github.com/geopy/geopy.git" ]]
    then
        pip install docutils #required for running tests
    elif [[ $URL == "https://github.com/gawel/pyquery.git" ]]
    then
        pip install webtest #required for running tests
    elif [[ $URL == "https://github.com/elastic/elasticsearch-dsl-py.git" ]]
    then
        pip install pytz #required for running tests
    elif [[ $URL == "https://github.com/marshmallow-code/marshmallow.git" ]]
    then
        pip install pytz simplejson #required for running tests
    elif [[ $URL == "https://github.com/pytest-dev/pytest.git" ]]
    then
        pip install hypothesis xmlschema #required for running tests
    fi

    #install pytest library
    pip install pytest

    #run test suite
    if [[ $1 == "scikit-learn" ]]
    then
        pytest --import-mode=importlib $TEST_SUITE #tests for scikit-learn need importlib to locate conftest
    else
        pytest $TEST_SUITE
    fi
    
    ((idx++))
    deactivate

done < "$URL_FILE"
\end{lstlisting}
